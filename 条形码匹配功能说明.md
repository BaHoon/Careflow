# 条形码匹配功能使用说明

## 功能概述

该功能用于验证执行任务条形码和患者条形码是否匹配，确保护士在正确的时间为正确的患者执行医嘱任务。

## 主要组件

### 1. 接口定义
- `IBarcodeMatchingService` - 条形码匹配服务接口
- `BarcodeMatchingResult` - 匹配结果模型
- `BarcodeValidationDetails` - 验证详情模型

### 2. 服务实现
- `BarcodeMatchingService` - 条形码匹配服务实现类

### 3. API控制器
- `BarcodeMatchingController` - 提供REST API接口

## API使用方法

### 端点
```
POST /api/barcodematching/validate
```

### 请求参数
- `executionTaskBarcode` (IFormFile) - 执行任务条形码图片文件
- `patientBarcode` (IFormFile) - 患者条形码图片文件  
- `toleranceMinutes` (int, 可选) - 允许的时间偏差分钟数，默认30分钟

### 身份验证要求
- 需要Bearer Token认证
- 用户必须是护士角色
- 系统会自动获取当前登录护士的ID

### 支持的图片格式
- PNG (.png)
- JPEG (.jpg, .jpeg)
- BMP (.bmp)
- GIF (.gif)

### 文件大小限制
- 最大10MB

### 响应示例

#### 匹配成功
```json
{
  "isMatched": true,
  "executionTaskId": 123,
  "patientId": "P001",
  "executorNurseId": "N001",
  "plannedStartTime": "2025-12-09T14:30:00",
  "scanTime": "2025-12-09T14:28:00",
  "actualStartTime": "2025-12-09T14:28:00",
  "timeDifferenceMinutes": 2.0,
  "validationDetails": {
    "executionTaskBarcodeDecoded": true,
    "patientBarcodeDecoded": true,
    "decodedExecutionTaskId": "123",
    "decodedPatientId": "P001",
    "executionTaskExists": true,
    "patientExists": true,
    "patientIdMatched": true,
    "executionTimeMatched": true,
    "executionTaskStatusValid": true
  },
  "errorMessage": ""
}
```

#### 匹配失败
```json
{
  "isMatched": false,
  "executionTaskId": 123,
  "patientId": "P002",
  "plannedStartTime": "2025-12-09T14:30:00",
  "scanTime": "2025-12-09T15:15:00",
  "timeDifferenceMinutes": 45.0,
  "validationDetails": {
    "executionTaskBarcodeDecoded": true,
    "patientBarcodeDecoded": true,
    "decodedExecutionTaskId": "123",
    "decodedPatientId": "P002",
    "executionTaskExists": true,
    "patientExists": true,
    "patientIdMatched": false,
    "executionTimeMatched": false,
    "executionTaskStatusValid": true
  },
  "errorMessage": "患者ID不匹配: 执行任务患者ID=P001, 扫码患者ID=P002; 执行时间超出允许范围: 计划时间=2025-12-09 14:30:00, 当前时间=2025-12-09 15:15:00, 时间差=45.0分钟, 允许范围=30分钟"
}
```

## 验证逻辑

### 1. 条形码解码
- 解码执行任务条形码，提取ExecutionTask ID
- 解码患者条形码，提取Patient ID
- 验证条形码格式是否正确

### 2. 数据库验证
- 验证执行任务是否存在
- 验证患者是否存在
- 获取执行任务的详细信息

### 3. 匹配验证
- **患者ID匹配**: 执行任务中的PatientId必须与扫码的患者ID一致
- **执行时间匹配**: 当前时间必须在计划执行时间的允许偏差范围内
- **任务状态验证**: 执行任务状态必须为"Pending"或"Running"

### 4. 匹配成功后的操作
当所有验证通过时，系统会自动：
- 设置ExecutionTask的`ActualStartTime`为当前时间
- 设置ExecutionTask的`ExecutorStaffId`为当前护士ID  
- 将ExecutionTask的`Status`更新为"Running"
- 更新ExecutionTask的`LastModifiedAt`时间戳
### 5. 时间偏差容忍
- 默认允许±30分钟的时间偏差
- 可以通过参数自定义偏差范围（0-1440分钟）
- 超出范围将导致匹配失败

## 错误处理

### 常见错误情况
1. **条形码解码失败**: 图片质量差、格式不支持等
2. **数据不存在**: 执行任务或患者在数据库中不存在
3. **患者不匹配**: 扫码的患者与任务中的患者不一致
4. **时间超出范围**: 执行时间超出允许的偏差范围
5. **任务状态无效**: 任务已完成、取消或其他非执行状态

### 错误响应
所有错误情况都会在`errorMessage`字段中提供详细的错误描述，并在`validationDetails`中标明具体的验证失败项。

## 使用场景

### 1. 护士给药前验证
```
护士登录系统 → 扫描执行任务条形码 → 扫描患者条形码 → 系统验证匹配 → 自动记录开始时间和执行护士 → 允许/拒绝执行
```

### 2. 移动端应用集成
前端应用可以调用此API进行实时验证，确保护理安全。

### 3. 审计记录
所有匹配结果可以用于护理质量审计和安全监控。

## 安全考虑

- 所有验证过程都有详细的日志记录
- 支持权限验证（需要在控制器上添加相应的授权特性）
- 输入验证确保文件安全性
- 错误信息不会泄露敏感的系统信息