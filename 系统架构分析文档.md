# CareFlow 医院护理管理系统 - 完整架构分析

## 一、系统概述

CareFlow 是一个**医院护理管理系统**，采用前后端分离架构，主要用于管理医嘱、护理任务、护士排班等医院核心业务流程。

### 1.1 技术栈

**后端：**
- .NET 8 / ASP.NET Core Web API
- Entity Framework Core (ORM)
- PostgreSQL (数据库)
- JWT 认证
- 分层架构设计（Core/Application/Infrastructure/WebApi）

**前端：**
- Vue 3 (Composition API)
- Element Plus (UI组件库)
- Vue Router (路由管理)
- Axios (HTTP客户端)
- Vite (构建工具)

**其他：**
- Docker Compose (容器化部署)
- Aspose.Barcode (条形码生成)

---

## 二、系统架构设计

### 2.1 分层架构

系统采用经典的**DDD（领域驱动设计）分层架构**：

```
┌─────────────────────────────────────┐
│      WebApi Layer (表现层)          │
│  - Controllers (API端点)            │
│  - 依赖注入配置                      │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│   Application Layer (应用层)        │
│  - Services (业务逻辑)              │
│  - DTOs (数据传输对象)              │
│  - Interfaces (服务接口)            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│      Core Layer (领域层)            │
│  - Models (实体模型)                │
│  - Enums (枚举类型)                 │
│  - Interfaces (领域接口)            │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│  Infrastructure Layer (基础设施层)  │
│  - DbContext (数据库上下文)         │
│  - Repositories (仓储实现)          │
│  - Migrations (数据库迁移)          │
└─────────────────────────────────────┘
```

### 2.2 项目结构

```
Careflow-new/
├── backend/
│   ├── CareFlow.Core/              # 领域层：核心业务模型
│   │   ├── Models/                 # 实体模型
│   │   │   ├── Medical/            # 医嘱相关
│   │   │   ├── Nursing/            # 护理相关
│   │   │   ├── Organization/       # 组织架构（医生、护士、患者）
│   │   │   └── Space/              # 空间管理（病区、床位）
│   │   ├── Enums/                  # 枚举定义
│   │   └── Interfaces/             # 领域接口
│   │
│   ├── CareFlow.Application/       # 应用层：业务逻辑
│   │   ├── Services/               # 业务服务
│   │   │   ├── MedicalOrder/       # 医嘱服务
│   │   │   ├── Nursing/            # 护理服务
│   │   │   ├── OrderAcknowledgement/  # 医嘱签收
│   │   │   ├── OrderApplication/      # 医嘱申请
│   │   │   └── Scheduling/            # 任务调度
│   │   ├── DTOs/                   # 数据传输对象
│   │   └── Interfaces/              # 服务接口
│   │
│   ├── CareFlow.Infrastructure/    # 基础设施层：数据访问
│   │   ├── ApplicationDbContext.cs # EF Core上下文
│   │   ├── Repositories/           # 仓储实现
│   │   └── Migrations/              # 数据库迁移
│   │
│   └── CareFlow.WebApi/            # Web API层：API端点
│       ├── Controllers/            # 控制器（21个）
│       ├── BackgroundServices/     # 后台服务
│       └── Program.cs              # 启动配置
│
└── frontend/                       # 前端应用
    ├── src/
    │   ├── api/                    # API调用封装
    │   ├── components/             # Vue组件
    │   ├── views/                  # 页面视图
    │   ├── layouts/                # 布局组件
    │   └── router/                 # 路由配置
    └── package.json
```

---

## 三、核心业务领域

### 3.1 组织架构模块

**核心实体：**
- `Department` - 科室
- `Staff` - 员工（基类）
  - `Doctor` - 医生（继承Staff）
  - `Nurse` - 护士（继承Staff）
- `Patient` - 患者
- `Ward` - 病区
- `Bed` - 床位

**关系：**
- 患者 → 床位 → 病区 → 科室
- 员工 → 科室
- 患者 → 主治医生

### 3.2 医嘱体系模块

**核心设计：继承体系（Table-Per-Type）**

```
MedicalOrder (基类)
├── MedicationOrder (药品医嘱)
├── InspectionOrder (检查医嘱)
├── SurgicalOrder (手术医嘱)
└── OperationOrder (操作医嘱)
```

**医嘱状态流转：**
```
PendingReceive (待签收)
    ↓
Accepted (已签收) / Rejected (已退回)
    ↓
PendingStop (待停嘱) → Stopped (已停嘱)
    ↓
Completed (已完成) / Cancelled (已撤销)
```

**关键字段：**
- `Status` - 医嘱状态
- `PlantEndTime` - 计划结束时间
- `IsLongTerm` - 是否长期医嘱
- `NurseId` - 负责护士（自动分配）
- 审计字段：签收时间、退回原因、停嘱时间等

**医嘱类型详解：**

#### 1. 药品医嘱 (MedicationOrder)
- 支持多药品混合（通过 `MedicationOrderItem` 关联）
- 执行策略：IMMEDIATE/SPECIFIC/CYCLIC/SLOTS
- 用法途径：口服、静脉、肌肉注射等
- 时段位掩码：支持多时段执行

#### 2. 检查医嘱 (InspectionOrder)
- 关联 RIS/LIS 系统
- 支持预约时间、地点
- 检查状态：Pending/InProgress/Completed
- 检查报告关联

#### 3. 手术医嘱 (SurgicalOrder)
- 术前准备任务拆分
- 支持术前宣讲、操作、药品
- 术前准备进度跟踪

#### 4. 操作医嘱 (OperationOrder)
- 操作代码（OpId）映射
- 频次类型：长期（x天y次）/ 临时（一次性）
- 自动生成执行任务

### 3.3 任务执行模块

**核心实体：`ExecutionTask`（执行任务）**

**任务类别（TaskCategory）：**
1. **Immediate (1)** - 即刻执行，扫码即完成
   - 示例：更换引流袋、更换敷料、口腔护理
2. **Duration (2)** - 持续执行，需要开始和结束时间
   - 示例：持续吸氧、持续导尿、持续静脉输液
3. **ResultPending (3)** - 需要等待结果，录入结果后完成
   - 示例：血糖监测、血压监测、体温监测
4. **DataCollection (4)** - 护理记录类，录入数据提交
5. **Verification (5)** - 核对类，扫描核对后结束

**任务状态：**
- `Pending` - 待执行
- `Running` - 执行中
- `Completed` - 已完成
- `Cancelled` - 已取消
- `Skipped` - 已跳过
- `OrderStopping` - 停嘱锁定

**双人双时机制：**
- `ExecutorStaffId` + `ActualStartTime` - 开始执行人/时间
- `CompleterNurseId` + `ActualEndTime` - 完成人/时间

**任务数据：**
- `DataPayload` - 任务定义数据（JSON）
- `ResultPayload` - 任务执行结果（JSON）

### 3.4 护士排班模块

**核心实体：**
- `ShiftType` - 班次定义（白班、小夜、大夜）
- `NurseRoster` - 护士排班记录

**排班逻辑：**
- 根据患者床位 → 病区 → 查询排班表
- 根据时间点查询当班护士
- 自动分配给医嘱和任务

### 3.5 条形码系统

**核心实体：`BarcodeIndex`（条形码索引）**

**功能：**
- 为患者、任务、药品等生成条形码
- 扫码验证患者身份
- 防止执行错误

**条形码类型：**
- 患者腕带条形码
- 执行任务条形码
- 药品条形码

### 3.6 护理记录模块

**核心实体：**
- `VitalSignsRecord` - 生命体征记录
- `NursingCareNote` - 护理记录单
- `NursingTask` - 护理任务
- `NursingRecordSupplement` - 护理记录补充说明

---

## 四、业务流程

### 4.1 医嘱创建流程

```
医生创建医嘱
    ↓
POST /api/{OrderType}/create
    ↓
{OrderType}Controller.Create()
    ↓
{OrderType}Service.CreateAsync()
    ├── 1. 验证数据
    ├── 2. 保存医嘱
    ├── 3. 自动分配护士
    │   └── NurseAssignmentService.CalculateResponsibleNurseAsync()
    │       ├── 查询患者床位
    │       ├── 查询病区
    │       └── 查询排班表
    └── 4. 生成执行任务（部分医嘱类型）
        └── {OrderType}TaskService.GenerateExecutionTasksAsync()
```

### 4.2 医嘱签收流程

```
护士查看待签收医嘱
    ↓
GET /api/OrderAcknowledgement/pending
    ↓
护士签收/退回
    ↓
POST /api/OrderAcknowledgement/acknowledge
    ├── 1. 更新医嘱状态（Accepted/Rejected）
    ├── 2. 记录签收时间、护士ID
    ├── 3. 插入状态历史记录
    ├── 4. 生成执行任务（如果签收）
    ├── 5. 为任务分配责任护士
    └── 6. 生成任务条形码
```

### 4.3 任务执行流程

```
护士查看任务列表
    ↓
GET /api/Nursing/my-tasks
    ↓
护士选择任务
    ↓
扫码验证（可选）
    ↓
POST /api/BarcodeMatching/validate
    ├── 扫描任务条形码
    ├── 扫描患者腕带条形码
    └── 验证：患者ID匹配、时间窗口、任务状态
    ↓
开始执行
    ↓
POST /api/Nursing/task/{taskId}/start
    ├── 更新任务状态：Running
    ├── 记录 ActualStartTime
    └── 记录 ExecutorStaffId
    ↓
执行任务（根据任务类别）
    ├── Immediate: 立即完成
    ├── Duration: 等待结束
    └── ResultPending: 录入结果
    ↓
完成任务
    ↓
POST /api/Nursing/task/{taskId}/complete
    ├── 更新任务状态：Completed
    ├── 记录 ActualEndTime
    ├── 记录 CompleterNurseId
    └── 保存 ResultPayload（如果有）
    ↓
检查医嘱状态
    └── 如果所有任务完成，更新医嘱状态为Completed
```

### 4.4 操作医嘱任务生成流程

**长期医嘱（IsLongTerm=true）：**
```
解析 FrequencyType: "x天y次"
    ↓
解析 FrequencyValue: "08:00,12:00,16:00"
    ↓
计算任务数量 = 周期数 × 次数
    ↓
为每个时间点生成任务
    ↓
过滤已过时间的任务
```

**临时医嘱（IsLongTerm=false）：**
```
解析 FrequencyType: "一次性"
    ↓
解析 FrequencyValue: "立即" 或 "14:30"
    ↓
生成1个任务
    ↓
验证时间未过期
```

### 4.5 后台调度服务

**NursingTaskScheduler（护理任务调度器）**

**功能：**
1. **每日任务生成**（DailyTaskGeneratorService）
   - 每天00:00触发
   - 为长期医嘱生成当日任务

2. **班次交接**（ShiftHandoverService）
   - 08:00、16:00、00:00触发
   - 处理未完成任务交接

3. **逾期提醒**（TaskReminderService）
   - 每10分钟检查一次
   - 提醒逾期任务

---

## 五、API端点汇总

### 5.1 认证相关
- `POST /api/Auth/login` - 登录
- `POST /api/Auth/logout` - 登出

### 5.2 医嘱管理
- `POST /api/MedicationOrder/create` - 创建药品医嘱
- `POST /api/InspectionOrder/create` - 创建检查医嘱
- `POST /api/SurgicalOrder/create` - 创建手术医嘱
- `POST /api/OperationOrder/create` - 创建操作医嘱
- `GET /api/MedicalOrder/{id}` - 查询医嘱详情

### 5.3 医嘱签收
- `GET /api/OrderAcknowledgement/pending` - 查询待签收医嘱
- `POST /api/OrderAcknowledgement/acknowledge` - 签收/退回医嘱
- `POST /api/OrderAcknowledgement/stop` - 停嘱
- `POST /api/OrderAcknowledgement/confirm-stop` - 确认停嘱

### 5.4 医嘱申请
- `POST /api/OrderApplication/pharmacy` - 申请药品
- `POST /api/OrderApplication/inspection` - 申请检查
- `GET /api/OrderApplication/status/{orderId}` - 查询申请状态

### 5.5 任务管理
- `GET /api/Nursing/my-tasks` - 查询我的任务
- `POST /api/Nursing/task/{taskId}/start` - 开始任务
- `POST /api/Nursing/task/{taskId}/complete` - 完成任务
- `POST /api/OperationOrderTask/{orderId}/generate` - 生成操作任务
- `POST /api/OperationOrderTask/{orderId}/refresh` - 刷新任务
- `POST /api/OperationOrderTask/{orderId}/rollback` - 回滚任务

### 5.6 条形码
- `GET /api/Barcode/patient/{patientId}` - 获取患者条形码
- `GET /api/Barcode/task/{taskId}` - 获取任务条形码
- `POST /api/BarcodeMatching/validate` - 验证条形码匹配

### 5.7 护理记录
- `POST /api/Nursing/vital-signs` - 记录生命体征
- `GET /api/Nursing/records/{patientId}` - 查询护理记录
- `POST /api/Nursing/care-note` - 创建护理记录单

### 5.8 护士排班
- `GET /api/NurseSchedule/roster` - 查询排班
- `POST /api/NurseSchedule/assign` - 分配排班

### 5.9 患者管理
- `GET /api/Patient/list` - 查询患者列表
- `GET /api/Patient/{id}` - 查询患者详情

---

## 六、数据库设计

### 6.1 核心表结构

**组织架构：**
- `Departments` - 科室表
- `Staffs` - 员工表（基表）
- `Doctors` - 医生表（继承Staff）
- `Nurses` - 护士表（继承Staff）
- `Patients` - 患者表
- `Wards` - 病区表
- `Beds` - 床位表

**医嘱体系：**
- `MedicalOrders` - 医嘱基表
- `MedicationOrders` - 药品医嘱表（继承MedicalOrder）
- `InspectionOrders` - 检查医嘱表（继承MedicalOrder）
- `SurgicalOrders` - 手术医嘱表（继承MedicalOrder）
- `OperationOrders` - 操作医嘱表（继承MedicalOrder）
- `MedicationOrderItems` - 药品医嘱明细表
- `MedicalOrderStatusHistories` - 医嘱状态历史表

**任务执行：**
- `ExecutionTasks` - 执行任务表
- `NursingTasks` - 护理任务表

**护理记录：**
- `VitalSignsRecords` - 生命体征记录表
- `NursingCareNotes` - 护理记录单表
- `NursingRecordSupplements` - 护理记录补充说明表

**排班系统：**
- `ShiftTypes` - 班次类型表
- `NurseRosters` - 护士排班表

**条形码：**
- `BarcodeIndexes` - 条形码索引表

**字典表：**
- `Drugs` - 药品字典表
- `HospitalTimeSlots` - 医院时段字典表
- `InspectionReports` - 检查报告表

### 6.2 继承策略

系统使用 **Table-Per-Type (TPT)** 继承策略：
- `Staff` 基表 + `Doctors`/`Nurses` 子表
- `MedicalOrder` 基表 + 4个子类型表

### 6.3 关键关系

```
Patient (1) ──→ (N) MedicalOrder
MedicalOrder (1) ──→ (N) ExecutionTask
MedicalOrder (1) ──→ (N) MedicationOrderItem
MedicalOrder (1) ──→ (N) MedicalOrderStatusHistory
Patient (N) ──→ (1) Bed ──→ (1) Ward ──→ (1) Department
Nurse (N) ──→ (1) Department
NurseRoster (N) ──→ (1) Nurse
NurseRoster (N) ──→ (1) Ward
```

---

## 七、前端架构

### 7.1 路由结构

```
/login                    # 登录页
/home                     # 首页
/nurse/                   # 护士工作台
  ├── dashboard          # 床位概览
  ├── tasks              # 我的任务
  ├── acknowledgement    # 医嘱签收
  ├── application        # 医嘱申请
  └── nursing-record     # 护理记录
/doctor/                  # 医生工作台
  └── order-entry        # 医嘱开具
```

### 7.2 组件结构

**布局组件：**
- `NurseLayout.vue` - 护士工作台布局
- `DoctorLayout.vue` - 医生工作台布局

**业务组件：**
- `BedCard.vue` - 床位卡片
- `PatientListPanel.vue` - 患者列表面板
- `TaskItem.vue` - 任务项
- `TaskTimeline.vue` - 任务时间线
- `StatusBadge.vue` - 状态徽章
- `NursingRecordForm.vue` - 护理记录表单
- `NursingRecordList.vue` - 护理记录列表
- `PatientInfoBar.vue` - 患者信息栏

### 7.3 API封装

前端API调用统一封装在 `src/api/` 目录：
- `medicationOrder.js` - 药品医嘱API
- `inspectionOrder.js` - 检查医嘱API
- `surgicalOrder.js` - 手术医嘱API
- `operationOrder.js` - 操作医嘱API
- `orderAcknowledgement.js` - 医嘱签收API
- `orderApplication.js` - 医嘱申请API
- `nursing.js` - 护理相关API
- `patient.js` - 患者API

---

## 八、关键设计模式

### 8.1 仓储模式（Repository Pattern）
- `IRepository<T, TKey>` - 通用仓储接口
- `EfRepository<T, TKey>` - EF Core实现
- 提供统一的CRUD操作

### 8.2 工厂模式（Factory Pattern）
- `IExecutionTaskFactory` - 任务工厂接口
- `OperationExecutionTaskFactory` - 操作任务工厂
- `SurgicalExecutionTaskFactory` - 手术任务工厂

### 8.3 策略模式（Strategy Pattern）
- 药品医嘱执行策略：IMMEDIATE/SPECIFIC/CYCLIC/SLOTS
- 任务类别策略：Immediate/Duration/ResultPending等

### 8.4 依赖注入（Dependency Injection）
- 所有服务通过DI容器管理
- 接口与实现分离
- 便于测试和扩展

---

## 九、安全机制

### 9.1 认证授权
- JWT Token认证
- 基于角色的访问控制（Role-Based）
- 路由守卫（前端）

### 9.2 数据验证
- 条形码匹配验证
- 时间窗口验证（±30分钟）
- 患者身份验证

### 9.3 审计追踪
- 医嘱状态历史记录
- 任务执行记录（双人双时）
- 操作时间戳记录

---

## 十、系统特色功能

### 10.1 智能护士分配
- 根据患者床位自动查询排班
- 根据时间点分配责任护士
- 支持任务级别的护士分配

### 10.2 任务自动生成
- 长期医嘱自动拆分任务
- 支持复杂频次规则（x天y次）
- 自动过滤过期任务

### 10.3 条形码集成
- 患者身份验证
- 任务执行验证
- 防止执行错误

### 10.4 后台调度
- 每日任务自动生成
- 班次交接处理
- 逾期任务提醒

### 10.5 状态管理
- 完整的医嘱状态流转
- 任务状态跟踪
- 状态历史记录

---

## 十一、部署配置

### 11.1 数据库配置
- PostgreSQL数据库
- 连接字符串配置在 `appsettings.json`
- EF Core迁移管理

### 11.2 时区配置
- 支持时区配置（China Standard Time）
- 任务调度考虑时区
- UTC时间存储，显示时转换

### 11.3 Docker部署
- `docker-compose.yml` 配置
- 支持容器化部署

---

## 十二、系统扩展性

### 12.1 医嘱类型扩展
- 通过继承 `MedicalOrder` 基类
- 实现对应的Service和Controller
- 注册到DI容器

### 12.2 任务类别扩展
- 扩展 `TaskCategory` 枚举
- 实现对应的任务处理逻辑
- 更新任务工厂

### 12.3 服务扩展
- 通过接口定义服务契约
- 实现服务类
- 注册到DI容器

---

## 十三、总结

CareFlow系统是一个**功能完整、架构清晰**的医院护理管理系统，主要特点：

1. **分层架构清晰**：Core/Application/Infrastructure/WebApi四层分离
2. **业务模型完整**：覆盖医嘱、任务、排班、护理记录等核心业务
3. **技术栈现代**：.NET 8 + Vue 3 + PostgreSQL
4. **设计模式应用**：仓储、工厂、策略等模式
5. **安全机制完善**：JWT认证、条形码验证、审计追踪
6. **自动化程度高**：自动分配护士、自动生成任务、后台调度

系统设计遵循**SOLID原则**和**DDD设计思想**，具有良好的可维护性和扩展性。

