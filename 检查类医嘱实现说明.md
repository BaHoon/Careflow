# 检查类医嘱后端实现说明文档

## 概述
本文档记录了检查类医嘱（Inspection Order）模块的后端实现，包括所有创建和修改的文件。

## 实现日期
2025年12月7日

## 业务逻辑概述

### 核心功能
检查类医嘱模块旨在解决"病人不知道去哪、什么时候去"的问题，通过信息流的透明化实现以下功能：

1. **预约回传**：系统模拟接收LIS/RIS系统的反馈，自动获取"预约时间"和"检查地点"
2. **导引单生成**：护士站打印（或发送至患者手机）一张"检查导引单"，包含时间、地点、注意事项
3. **状态追踪**：护士看板上实时更新患者状态：待前往 → 检查中 → 已回病房 → 报告已出

### 检查类型覆盖
- CT检查（RIS系统）
- 核磁共振（RIS系统）
- 抽血检查（LIS系统）
- 尿检等化验（LIS系统）
- B超检查（RIS系统）

## 文件清单

### 1. 新建文件

#### 1.1 枚举类型
**文件路径**: `backend/CareFlow.Core/Enums/InspectionEnums.cs`

**内容说明**:
- `InspectionOrderStatus`: 检查医嘱状态枚举
  - Pending（待前往）
  - InProgress（检查中）
  - BackToWard（已回病房）
  - ReportCompleted（报告已出）
  - Cancelled（已取消）

- `InspectionReportStatus`: 检查报告状态枚举
  - Pending（待出）
  - Completed（已出）

- `InspectionSource`: 检查项目来源系统枚举
  - RIS（放射信息系统）
  - LIS（实验室信息系统）

#### 1.2 数据传输对象（DTOs）

**文件路径**: `backend/CareFlow.Application/DTOs/Inspection/InspectionOrderDto.cs`

**包含的DTO类**:
- `CreateInspectionOrderDto`: 创建检查医嘱请求
- `UpdateAppointmentDto`: 预约信息更新（模拟从RIS/LIS接收）
- `UpdateInspectionStatusDto`: 更新检查状态
- `InspectionGuideDto`: 检查导引单
- `InspectionOrderDetailDto`: 检查医嘱详情响应
- `NurseInspectionBoardDto`: 护士看板中的检查项目

**文件路径**: `backend/CareFlow.Application/DTOs/Inspection/InspectionReportDto.cs`

**包含的DTO类**:
- `CreateInspectionReportDto`: 创建检查报告（模拟从RIS/LIS接收）
- `InspectionReportDetailDto`: 检查报告详情响应
- `UpdateReportStatusDto`: 更新报告状态

#### 1.3 服务接口

**文件路径**: `backend/CareFlow.Application/Interfaces/IInspectionService.cs`

**接口方法**:
- 检查医嘱相关方法（8个）
  - 创建检查医嘱
  - 更新预约信息
  - 更新检查状态
  - 获取检查医嘱详情
  - 生成检查导引单
  - 获取患者的所有检查医嘱
  - 获取护士看板数据
- 检查报告相关方法（4个）
  - 创建检查报告
  - 获取检查报告详情
  - 根据医嘱ID获取报告列表
  - 更新报告状态
- 测试数据生成（1个）
  - 生成模拟检查医嘱数据

#### 1.4 服务实现

**文件路径**: `backend/CareFlow.Application/Services/InspectionService.cs`

**实现说明**:
- 完整实现了 `IInspectionService` 接口的所有方法
- 包含辅助方法：
  - `GenerateRisLisId()`: 生成RIS/LIS申请单号
  - `GetStatusDisplayText()`: 获取状态的中文显示文本
- 包含模拟数据生成逻辑，生成5条测试检查医嘱数据

#### 1.5 控制器

**文件路径**: `backend/CareFlow.WebApi/Controller/InspectionController.cs`

**API端点**:
- `POST /api/inspection/orders` - 创建检查医嘱
- `PUT /api/inspection/orders/appointment` - 更新预约信息
- `PUT /api/inspection/orders/status` - 更新检查状态
- `GET /api/inspection/orders/{orderId}` - 获取检查医嘱详情
- `GET /api/inspection/orders/{orderId}/guide` - 生成检查导引单
- `GET /api/inspection/orders/patient/{patientId}` - 获取患者的所有检查医嘱
- `GET /api/inspection/nurse-board/{wardId}` - 获取护士看板数据
- `POST /api/inspection/reports` - 创建检查报告
- `GET /api/inspection/reports/{reportId}` - 获取检查报告详情
- `GET /api/inspection/reports/order/{orderId}` - 根据医嘱ID获取报告列表
- `PUT /api/inspection/reports/status` - 更新报告状态
- `POST /api/inspection/mock-data` - 生成模拟数据

### 2. 修改文件

#### 2.1 实体模型

**文件路径**: `backend/CareFlow.Core/Models/Medical/MedicalOrder.cs`

**修改说明**:
- 在 `InspectionOrder` 类中添加了以下字段：
  - `ItemName`: 检查项目名称
  - `Source`: 检查来源（RIS/LIS）枚举
  - `InspectionStatus`: 检查状态枚举
  - `Reports`: 导航属性，关联检查报告集合
- 将部分字段改为可空类型，以适应不同阶段的数据状态
- 添加了对 `CareFlow.Core.Enums` 命名空间的引用

**文件路径**: `backend/CareFlow.Core/Models/Medical/InspectionReport.cs`

**修改说明**:
- 将 `ReportStatus` 改为使用 `InspectionReportStatus` 枚举
- 将 `ReportSource` 改为使用 `InspectionSource` 枚举
- 添加了 `Reviewer` 导航属性，关联审核医生
- 将部分字段改为可空类型
- 添加了对 `CareFlow.Core.Enums` 命名空间的引用

#### 2.2 服务注册

**文件路径**: `backend/CareFlow.WebApi/Program.cs`

**修改说明**:
- 在依赖注入容器中注册了 `IInspectionService` 服务
- 添加代码：
  ```csharp
  builder.Services.AddScoped<CareFlow.Application.Interfaces.IInspectionService, 
                            CareFlow.Application.Services.InspectionService>();
  ```

## 数据库设计

### InspectionOrder 表结构
| 字段名 | 类型 | 说明 |
|--------|------|------|
| Id | long | 主键，医嘱ID |
| PatientId | string | 患者ID（外键） |
| DoctorId | string | 医生ID（外键） |
| ItemCode | string | 检查项目代码 |
| ItemName | string | 检查项目名称 |
| RisLisId | string | 申请单号 |
| Location | string | 检查科室位置 |
| Source | enum | 检查来源（RIS/LIS） |
| AppointmentTime | DateTime? | 预约时间 |
| AppointmentPlace | string? | 预约地点 |
| Precautions | string? | 注意事项 |
| CheckStartTime | DateTime? | 检查开始时间 |
| CheckEndTime | DateTime? | 检查结束时间 |
| BackToWardTime | DateTime? | 返回病房时间 |
| ReportTime | DateTime? | 报告完成时间 |
| ReportId | string? | 报告编号 |
| InspectionStatus | enum | 检查状态 |
| IsLongTerm | bool | 是否长期医嘱 |
| PlantEndTime | DateTime | 计划结束时间 |
| Status | string | 通用状态（基类字段） |
| OrderType | string | 医嘱类型（基类字段） |
| CreateTime | DateTime | 创建时间 |

### InspectionReport 表结构
| 字段名 | 类型 | 说明 |
|--------|------|------|
| Id | long | 主键，报告ID |
| OrderId | long | 医嘱ID（外键） |
| PatientId | string | 患者ID（外键，冗余） |
| RisLisId | string | RIS/LIS报告编号 |
| ReportTime | DateTime | 报告时间 |
| ReportStatus | enum | 报告状态 |
| Findings | string? | 检查所见/情况描述 |
| Impression | string? | 诊断意见/诊断性总结 |
| AttachmentUrl | string? | 影像PDF/图片链接 |
| ReviewerId | string? | 审核医生ID（外键） |
| ReportSource | enum | 数据来源（RIS/LIS） |
| CreateTime | DateTime | 创建时间 |

## 业务流程

### 1. 创建检查医嘱
```
医生 → POST /api/inspection/orders
     → InspectionService.CreateInspectionOrderAsync()
     → 验证患者和医生
     → 生成RIS/LIS申请单号
     → 创建InspectionOrder实体
     → 状态：Pending（待前往）
```

### 2. 接收预约反馈（模拟RIS/LIS）
```
外部系统 → PUT /api/inspection/orders/appointment
         → InspectionService.UpdateAppointmentAsync()
         → 更新预约时间、地点、注意事项
         → 状态：Appointed（已预约）
```

### 3. 生成检查导引单
```
护士 → GET /api/inspection/orders/{orderId}/guide
     → InspectionService.GenerateInspectionGuideAsync()
     → 返回包含患者信息、检查项目、预约时间、地点、注意事项的导引单
```

### 4. 更新检查状态
```
护士/系统 → PUT /api/inspection/orders/status
          → InspectionService.UpdateInspectionStatusAsync()
          → 根据状态自动记录对应时间戳
          → 状态流转：Appointed → InProgress → BackToWard
```

### 5. 接收检查报告（模拟RIS/LIS）
```
外部系统 → POST /api/inspection/reports
         → InspectionService.CreateInspectionReportAsync()
         → 创建InspectionReport实体
         → 自动更新医嘱状态：ReportCompleted（报告已出）
         → 记录报告完成时间
```

### 6. 护士看板查询
```
护士 → GET /api/inspection/nurse-board/{wardId}
     → InspectionService.GetNurseBoardDataAsync()
     → 按病区查询所有未完成的检查医嘱
     → 按预约时间排序
     → 显示患者姓名、床号、检查项目、预约时间、当前状态
```

## 测试数据

### 生成模拟数据
调用 `POST /api/inspection/mock-data` 端点可生成5条测试检查医嘱：

1. **胸部CT平扫**
   - 来源：RIS
   - 状态：已预约
   - 预约时间：2小时后
   - 注意事项：检查前需脱去金属物品

2. **头部核磁共振**
   - 来源：RIS
   - 状态：待前往
   - 尚未预约

3. **血常规**
   - 来源：LIS
   - 状态：已预约
   - 预约时间：1小时后
   - 注意事项：需空腹8小时以上

4. **尿常规**
   - 来源：LIS
   - 状态：已回病房
   - 完整时间线已记录

5. **腹部B超**
   - 来源：RIS
   - 状态：已预约
   - 预约时间：3小时后
   - 注意事项：检查前需憋尿

## 技术要点

### 1. 状态管理
- 使用枚举类型确保状态的类型安全
- 状态转换时自动记录对应的时间戳
- 状态流转遵循业务逻辑顺序

### 2. 数据关联
- InspectionOrder 与 Patient、Doctor 的多对一关系
- InspectionOrder 与 InspectionReport 的一对多关系
- InspectionReport 中冗余 PatientId 便于快速查询

### 3. 外部系统集成（模拟）
- 生成符合格式的RIS/LIS申请单号
- 预留接口接收外部系统的预约反馈和报告数据

### 4. 异步操作
- 所有服务方法均采用异步编程模式（async/await）
- 提升系统并发处理能力

## 后续扩展建议

1. **实际RIS/LIS集成**
   - 实现真实的RIS/LIS系统对接
   - 建立消息队列接收外部系统推送

2. **导引单打印**
   - 实现PDF生成功能
   - 支持二维码扫描签到

3. **移动端推送**
   - 实现患者手机端通知
   - 提供检查指引导航

4. **权限控制**
   - 添加基于角色的访问控制
   - 限制不同角色的操作权限

5. **审计日志**
   - 记录所有状态变更历史
   - 支持操作追溯

## 注意事项

1. **数据库迁移**：修改了实体模型后，需要运行数据库迁移以更新数据库架构
2. **枚举值存储**：枚举在数据库中以整数形式存储
3. **时区处理**：所有时间使用UTC时间，前端展示时需转换为本地时间
4. **错误处理**：所有控制器方法都包含异常处理，返回友好的错误信息

## 联系信息
如有问题，请联系开发团队。

额外：
1.添加getqueryable方法到EFrepository.cs最末尾