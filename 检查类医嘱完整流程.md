# 检查类医嘱完整流程说明

## 📋 业务流程概览

```
步骤1: 医嘱下达 (状态: 待前往)
   ↓
步骤2: 病房护士发送申请
   ↓
步骤3: 检查站护士打印预约单 → 生成护士任务
   ↓
步骤4: 病房护士打印预约单交给患者
   ↓
步骤5: 检查站扫码签到 (状态: 检查中)
   ↓
步骤6: 检查站扫码完成 (状态: 已回病房)
   ↓
步骤7: 检查站发送报告 (状态: 报告已出) → 生成查看报告任务
```

## 📝 本次任务修改的代码文件

### **1. 新增文件**

| 文件路径 | 说明 | 主要功能 |
|---------|------|---------|
| `backend/CareFlow.Application/Services/MedicalOrder/InspectionOrderTaskService.cs` | 检查类医嘱任务拆分服务（新增） | • 实现统一的 DataPayload 格式<br>• 生成4种任务类型（打印预约单、签到、完成、查看报告）<br>• 支持任务自动生成 |

### **2. 修改的文件**

| 文件路径 | 修改内容 | 关键变更 |
|---------|---------|---------|
| `backend/CareFlow.Application/Services/InspectionService.cs` | 集成任务拆分服务 | • 注入 `InspectionOrderTaskService`<br>• 注入 `IRepository<ExecutionTask, long>`<br>• `UpdateAppointmentAsync` 方法中调用 `CreateTasks` 生成3个任务<br>• `CreateInspectionReportAsync` 方法中调用 `CreateReportReviewTask` 生成查看报告任务 |
| `backend/CareFlow.WebApi/Controller/InspectionController.cs` | 新增扫码接口 | • 注入 `IRepository<ExecutionTask, long>`<br>• 新增 `POST /api/inspection/scan/check-in` 接口（双码扫描签到）<br>• 新增 `POST /api/inspection/scan/check-complete` 接口（单码扫描完成）<br>• 新增 DTO：`DualScanDto`、`CompleteScanDto` |

### **3. 文件依赖关系**

```
InspectionController.cs
    ↓ 调用
InspectionService.cs
    ↓ 调用
InspectionOrderTaskService.cs
    ↓ 生成
ExecutionTask (任务实体)
```



---

## 🔧 详细步骤与接口

### **步骤1：医嘱下达**

**操作者**：医生（HIS系统）

**接口**：`POST /api/inspection/orders`

**状态变化**：无 → `Pending`（待前往）

**请求体**：
```json
{
  "patientId": "P001",
  "doctorId": "D001",
  "itemCode": "CT001",
  "location": "放射科",
  "source": 1,
  "isLongTerm": false,
  "plantEndTime": "2025-12-10T23:59:59Z"
}
```

**说明**：医嘱创建后状态为"待前往"，等待病房护士发送申请。

---

### **步骤2：病房护士发送申请**

**操作者**：病房护士

**操作**：在护士工作站看到新医嘱，点击"发送给检查站"按钮

**说明**：这一步可能只是前端操作，后端无需特殊接口，只是通知检查站有新申请。

---

### **步骤3：检查站护士打印预约单**

**操作者**：检查站护士

**接口**：`PUT /api/inspection/orders/appointment`

**状态变化**：`Pending`（无变化，仍为待前往）

**请求体**：
```json
{
  "orderId": 123,
  "appointmentTime": "2025-12-10T10:00:00Z",
  "appointmentPlace": "放射科3号机房",
  "precautions": "检查前禁食4小时，提前半小时到达"
}
```

**系统自动操作**：
✅ 生成3个护士任务：
1. 病房护士任务：打印预约单（`INSP_PRINT_GUIDE`）
2. 检查站护士任务：签到确认（`INSP_CHECKIN`）
3. 检查站护士任务：完成确认（`INSP_COMPLETE`）

**说明**：
- 检查站护士在系统中录入可预约的时间段、空闲房间、注意事项
- 系统自动生成预约单（包含二维码）
- 如果一张检查单有多个检查项目，每个项目一个二维码（对应一个任务）

---

### **步骤4：病房护士打印预约单交给患者**

**操作者**：病房护士
**操作**：完成"打印预约单"任务

**接口**：可选，可以调用任务完成接口

**说明**：
- 病房护士看到待办任务"打印预约单"
- 打印预约单并交给患者
- 告知患者检查时间、地点、注意事项

**预约单内容**：
```
┌─────────────────────────────┐
│   检查预约单                │
├─────────────────────────────┤
│ 患者：张三 (P001)           │
│ 检查项目：CT001 - 胸部CT     │
│                             │
│ 预约时间：2025-12-10 10:00  │
│ 检查地点：放射科3号机房       │
│                             │
│ 注意事项：                   │
│ • 检查前禁食4小时            │
│ • 提前半小时到达             │
│                             │
│ [二维码]                    │
│ 扫码签到                    │
└─────────────────────────────┘
```

---

### **步骤5：检查站扫码签到**

**操作者**：检查站护士

**接口**：`POST /api/inspection/scan/check-in`

**状态变化**：`Pending` → `InProgress`（检查中）

**扫码流程**：
1. 先扫描**检查单上的二维码**（验证任务）
2. 再扫描**患者手环上的二维码**（二次确认患者身份）

**请求体**：
```json
{
  "taskId": 456,        // 从检查单二维码解析
  "patientId": "P001",  // 从患者手环二维码解析
  "nurseId": "N002"     // 扫码的检查站护士ID
}
```

**系统自动操作**：
✅ 更新医嘱状态为"检查中"
✅ 自动完成签到任务
✅ 记录扫码护士和时间

**响应**：
```json
{
  "message": "✅ 签到成功！患者已开始检查",
  "orderId": 123,
  "patientId": "P001",
  "status": "检查中"
}
```

---

### **步骤6：检查站扫码完成**

**操作者**：检查站护士

**接口**：`POST /api/inspection/scan/check-complete`

**状态变化**：`InProgress` → `BackToWard`（已回病房）

**扫码流程**：
- 只需扫描**患者手环二维码**（系统自动查找该患者的待完成任务）

**请求体**：
```json
{
  "patientId": "P001",
  "nurseId": "N002"
}
```

**系统自动操作**：
✅ 更新医嘱状态为"已回病房"
✅ 自动完成检查完成任务
✅ 记录扫码护士和时间

**响应**：
```json
{
  "message": "✅ 检查完成确认成功！患者可返回病房",
  "orderId": 123,
  "patientId": "P001",
  "status": "已回病房"
}
```

---

### **步骤7：检查站发送报告**

需要由检查站护士单独调用此接口
调用 CreateInspectionReportAsync 提交报告数据
此时才将状态更新为 ReportCompleted
自动生成"审阅报告"任务

**操作者**：检查站护士

**接口**：`POST /api/inspection/reports`

**状态变化**：`BackToWard` → `ReportCompleted`（报告已出）

**请求体**：
```json
{
  "orderId": 123,
  "risLisId": "RIS-2025121001",
  "findings": "双肺纹理清晰，未见明显实质性病变。心影大小形态正常，纵隔居中，未见异常肿块及淋巴结肿大。",
  "impression": "胸部CT未见明显异常",
  "attachmentUrl": "http://example.com/reports/123.pdf",
  "reviewerId": "D001",
  "reportSource": 1
}
```

**系统自动操作**：
✅ 保存报告数据
✅ 更新医嘱状态为"报告已出"
✅ 自动生成"查看报告"任务（`INSP_REVIEW_REPORT`），分配给病房护士

**说明**：
- 报告数据需要提前准备好（在 DbInitializer 中预置）
- 检查站护士从系统中选择对应的预置报告发送

---

## 📱 护士任务列表展示

### **病房护士任务**

```
待办任务
├─ [待完成] 打印检查预约单 - 患者张三
│   └─ 检查：CT001
│   └─ 预约时间：2025-12-10 10:00
│
└─ [待完成] 查看检查报告 - 患者张三
    └─ 检查：CT001
    └─ 报告已出，请查看
```

### **检查站护士任务**

```
待办任务
├─ [待完成] 患者签到 - 张三
│   └─ 检查：CT001
│   └─ 预约时间：2025-12-10 10:00
│   └─ [扫码签到]
│
└─ [待完成] 检查完成确认 - 张三
    └─ 检查：CT001
    └─ [扫码完成]
```

---

## 🎯 关键设计点

### **1. 任务自动生成时机**

| 触发点 | 生成的任务 | 数量 |
|--------|-----------|------|
| 步骤3：预约信息录入 | 打印预约单、签到确认、完成确认 | 3个 |
| 步骤7：报告发送 | 查看报告 | 1个 |

### **2. 扫码逻辑**

**签到扫码（双码）**：
1. 扫检查单码 → 验证任务类型
2. 扫患者手环码 → 验证患者身份
3. 双码匹配 → 完成签到

**完成扫码（单码）**：
1. 扫患者手环码 → 自动查找该患者的待完成任务
2. 完成任务 → 状态更新

### **3. 状态流转**

```
Pending (待前往)
   ↓ 扫码签到
InProgress (检查中)
   ↓ 扫码完成
BackToWard (已回病房)
   ↓ 发送报告
ReportCompleted (报告已出)
```

### **4. 数据准备**

**DbInitializer 需要预置**：
- 检查医嘱（`InspectionOrder`）
- 检查报告（`InspectionReport`）
- 护士（`Nurse`）
- 患者（`Patient`）

---

## 🔍 测试流程

### **测试数据准备**

```csharp
// 1. 创建医嘱（DbInitializer）
new InspectionOrder
{
    PatientId = "P001",
    DoctorId = "D001",
    ItemCode = "CT001",
    Location = "放射科",
    InspectionStatus = InspectionOrderStatus.Pending
}

// 2. 预置报告（DbInitializer）
new InspectionReport
{
    RisLisId = "RIS-2025121001",
    Findings = "检查所见内容",
    Impression = "诊断意见"
}
```

### **测试步骤**

1. 启动后端：`dotnet run --project CareFlow.WebApi`
2. 打开 Swagger：`http://localhost:5181/swagger`
3. 依次调用接口测试每个步骤

---

## ❓ 常见问题

**Q1: 为什么签到要扫两次码？**  
A: 为了防止搞错患者。第一次扫检查单确认是哪个检查，第二次扫患者手环确认是哪个患者。

**Q2: 报告数据怎么来？**  
A: 提前在 DbInitializer 中预置好报告模板，检查站护士从列表中选择发送。

**Q3: 如果患者没来检查怎么办？**  
A: 签到任务会显示"超时未完成"，护士可以看到异常。

**Q4: 可以取消预约吗？**  
A: 可以增加"取消预约"接口，回滚未完成的任务。

---

## 📚 相关文件

- `InspectionService.cs` - 业务逻辑服务
- `InspectionController.cs` - API接口
- `InspectionOrderTaskService.cs` - 任务拆分服务
- `DbInitializer.cs` - 测试数据初始化

---

**更新时间**：2025年12月9日  
**负责人**：检查类医嘱模块开发
