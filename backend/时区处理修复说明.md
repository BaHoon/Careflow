# 时区处理修复说明

## 一、修复原则

根据用户要求，整个医院系统**全部使用中国时间**：

1. **输入的时间点都是中国时间**
2. **代码中获取时间函数获取到的时间是UTC时间（美国时间）**
3. **在比较时间时，要把获取到的UTC时间转化为中国时间再跟输入并保存在表里的时间做比较**
4. **所有保存在表中的时间都保持中国时间形式**

## 二、核心修改

### 2.1 TimeZoneHelper 工具类修改

#### 新增方法

1. **`StoreChinaTime(DateTime chinaTime)`**
   - 用途：存储时间到数据库
   - 功能：直接存储中国时间，不转换为UTC
   - 说明：数据库存储使用中国时间

2. **`CompareChinaTime(DateTime time1, DateTime time2)`**
   - 用途：比较两个时间
   - 功能：确保比较时使用相同的时区（中国时间）

3. **`IsTimePassed(DateTime time)`**
   - 用途：检查时间是否已过
   - 功能：基于当前中国时间判断

#### 修改的方法

1. **`ToChinaTime(DateTime time)`**
   - 修改：如果时间Kind为Unspecified，假设为中国时间（数据库存储的时间）
   - 说明：从数据库读取的时间直接当作中国时间使用

2. **`ToUtcTime(DateTime chinaTime)`**
   - 状态：标记为 `[Obsolete]`
   - 说明：保留用于兼容，但实际应该使用 `StoreChinaTime`

### 2.2 操作类医嘱相关修改

#### OperationOrderManager.cs
- `CreateTime`: 使用 `StoreChinaTime` 直接存储中国时间
- `targetTime`: 直接使用中国时间，不转换

#### OperationOrderTaskService.cs
- `EndTime`: 使用 `StoreChinaTime` 直接存储中国时间

#### OperationExecutionTaskFactory.cs
- **长期医嘱日期计算**：
  - 修改前：`TimeZoneHelper.ToChinaTime(order.CreateTime).Date`
  - 修改后：`order.CreateTime.Date`（直接使用，数据库存储的是中国时间）

- **任务时间生成**：
  - 修改前：`TimeZoneHelper.ToUtcTime(plannedTimeChina)`
  - 修改后：`TimeZoneHelper.StoreChinaTime(plannedTimeChina)`

- **时间过滤逻辑**：
  - 修改前：转换为UTC后比较
  - 修改后：直接比较中国时间

### 2.3 数据库初始化修改

#### Dbinitializer.cs
- 所有操作医嘱的 `CreateTime` 和 `PlantEndTime`：
  - 修改前：`TimeZoneHelper.ToUtcTime(...)`
  - 修改后：`TimeZoneHelper.StoreChinaTime(...)`
- `currentTime`：
  - 修改前：`DateTime.UtcNow`
  - 修改后：`TimeZoneHelper.GetChinaTimeNow()`

## 三、时间处理流程

### 3.1 存储时间流程

```
获取当前时间（UTC）
    ↓
TimeZoneHelper.GetChinaTimeNow() → 转换为中国时间
    ↓
TimeZoneHelper.StoreChinaTime() → 存储到数据库（中国时间）
    ↓
数据库存储（中国时间，Kind=Unspecified）
```

### 3.2 读取时间流程

```
从数据库读取时间（Kind=Unspecified，实际是中国时间）
    ↓
直接使用（当作中国时间）
    ↓
或使用 TimeZoneHelper.ToChinaTime() 确保是中国时间
```

### 3.3 时间比较流程

```
获取当前时间（UTC）
    ↓
TimeZoneHelper.GetChinaTimeNow() → 转换为中国时间
    ↓
从数据库读取时间（中国时间）
    ↓
直接比较（都是中国时间）
```

## 四、关键代码示例

### 4.1 存储时间

```csharp
// 获取当前中国时间
var chinaTime = TimeZoneHelper.GetChinaTimeNow();

// 存储到数据库（直接存储中国时间）
order.CreateTime = TimeZoneHelper.StoreChinaTime(chinaTime);
```

### 4.2 读取和比较时间

```csharp
// 从数据库读取时间（假设是中国时间）
var orderTime = order.CreateTime;

// 获取当前中国时间
var currentTime = TimeZoneHelper.GetChinaTimeNow();

// 直接比较（都是中国时间）
if (orderTime < currentTime)
{
    // 时间已过
}
```

### 4.3 时间过滤

```csharp
// 获取当前中国时间
var currentTimeChina = TimeZoneHelper.GetChinaTimeNow();

// 过滤已过时间的任务
var tasksToRemove = tasks.Where(t => 
{
    var taskTime = TimeZoneHelper.ToChinaTime(t.PlannedStartTime);
    return taskTime < currentTimeChina;
}).ToList();
```

## 五、数据库配置

### 5.1 PostgreSQL 时区设置

虽然数据库存储中国时间，但PostgreSQL的时区设置不影响存储的值（因为我们直接存储DateTime值）。

**建议配置**：
```sql
-- 设置为 UTC（不影响存储，只是影响显示）
SET timezone = 'UTC';
```

或者保持默认设置。

### 5.2 EF Core 配置

EF Core 会将 `DateTime` 类型存储为 `timestamp with time zone`，但实际存储的值是我们传入的值（中国时间）。

## 六、注意事项

### 6.1 时间比较

**重要**：所有时间比较都应该：
1. 确保比较的两个时间都是中国时间
2. 使用 `TimeZoneHelper.ToChinaTime()` 确保时间正确
3. 不要直接比较不同时区的时间

### 6.2 数据库存储

**重要**：
- 所有时间字段都存储中国时间
- 使用 `TimeZoneHelper.StoreChinaTime()` 存储
- 不要使用 `ToUtcTime()`（已废弃）

### 6.3 时间获取

**重要**：
- 获取当前时间：使用 `TimeZoneHelper.GetChinaTimeNow()`
- 不要使用 `DateTime.UtcNow` 或 `DateTime.Now`

## 七、测试验证

### 7.1 验证存储时间

```csharp
// 创建医嘱
var order = new OperationOrder
{
    CreateTime = TimeZoneHelper.StoreChinaTime(TimeZoneHelper.GetChinaTimeNow())
};

// 保存到数据库
await _repository.AddAsync(order);

// 从数据库读取
var savedOrder = await _repository.GetByIdAsync(order.Id);

// 验证：保存的时间应该是中国时间
// 例如：当前UTC时间是 2024-01-01 00:00:00
// 中国时间应该是 2024-01-01 08:00:00
// 数据库中存储的应该是 2024-01-01 08:00:00
```

### 7.2 验证时间比较

```csharp
// 创建任务，计划时间为今天 14:00（中国时间）
var task = new ExecutionTask
{
    PlannedStartTime = TimeZoneHelper.StoreChinaTime(
        TimeZoneHelper.GetChinaTimeToday().AddHours(14))
};

// 当前时间：今天 16:00（中国时间）
var currentTime = TimeZoneHelper.GetChinaTimeNow();

// 比较
var taskTime = TimeZoneHelper.ToChinaTime(task.PlannedStartTime);
if (taskTime < currentTime)
{
    // 任务已过期（正确）
}
```

## 八、修改文件清单

### 8.1 核心工具类
- ✅ `CareFlow.Core/Utils/TimeZoneHelper.cs`

### 8.2 操作类医嘱服务
- ✅ `CareFlow.Application/Services/MedicalOrder/OperationOrderManager.cs`
- ✅ `CareFlow.Application/Services/MedicalOrder/OperationOrderTaskService.cs`
- ✅ `CareFlow.Application/Services/MedicalOrder/OperationExecutionTaskFactory.cs`

### 8.3 数据库初始化
- ✅ `CareFlow.Infrastructure/Data/Dbinitializer.cs`

## 九、后续工作

### 9.1 需要检查的其他服务

以下服务可能也需要时区修复（不在本次修改范围内）：
- `MedicationOrderTaskService.cs`
- `InspectionOrderTaskService.cs`
- `SurgicalOrderTaskService.cs`
- 其他 Controller 层文件

### 9.2 建议

1. **统一时间处理**：所有服务都应该使用 `TimeZoneHelper`
2. **代码审查**：检查所有使用 `DateTime.UtcNow` 的地方
3. **单元测试**：编写时区处理的单元测试

## 十、总结

现在整个系统已经统一使用中国时间：

1. ✅ **获取时间**：使用 `TimeZoneHelper.GetChinaTimeNow()`（从UTC转换为中国时间）
2. ✅ **存储时间**：使用 `TimeZoneHelper.StoreChinaTime()`（直接存储中国时间）
3. ✅ **读取时间**：直接使用，当作中国时间处理
4. ✅ **比较时间**：确保都是中国时间后再比较

所有时间操作都基于中国时间，符合用户要求。

