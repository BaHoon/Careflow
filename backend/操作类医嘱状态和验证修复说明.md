# 操作类医嘱状态和验证修复说明

## 一、修复内容

### 1. 任务状态限制为四种

**修复前**：
- 操作类医嘱的任务状态可能包含：Pending、InProgress、Running、Completed、Stopped等
- 代码中检查了Running状态

**修复后**：
- 操作类医嘱的任务状态只有四种：**Pending、InProgress、Completed、Stopped**
- 移除了所有Running状态的引用
- 使用InProgress表示执行中状态

**修复位置**：
1. `OperationOrderTaskService.HasPendingTasksAsync()` - 移除了Running状态检查
2. `OperationOrderTaskService.RollbackPendingTasksAsync()` - 移除了Running状态检查
3. `OperationOrderTaskService.CheckAndUpdateOrderStatusAsync()` - 更新了状态检查逻辑
4. 所有相关文档 - 更新了状态说明

### 2. 病人选择验证

**修复前**：
- 操作类医嘱暂存时没有验证病人选择
- 暂存数据中没有包含patientId字段

**修复后**：
- 在`isFormValid`中添加了`selectedPatient.value`的验证
- 在暂存数据中添加了`patientId`字段
- 与药品类医嘱、检查类医嘱保持一致

**修复位置**：
1. `frontend/src/views/OrderEntry.vue` - `isFormValid`计算属性
2. `frontend/src/views/OrderEntry.vue` - `addToCart`方法

---

## 二、状态流转逻辑

### 操作类医嘱任务状态流转

```
任务生成
  ↓
Pending (待执行)
  ↓
InProgress (执行中) - 护士开始执行任务时
  ↓
Completed (已完成) - 任务执行完毕
  或
Stopped (已停止) - 医嘱停止或任务被取消
```

### 状态说明

1. **Pending (待执行)**
   - 任务刚生成时的初始状态
   - 等待护士执行

2. **InProgress (执行中)**
   - 护士开始执行任务时的状态
   - 设置ActualStartTime和ExecutorStaffId
   - 对于Immediate类任务，可能立即完成
   - 对于Duration类任务，需要等待护士结束
   - 对于ResultPending类任务，需要等待护士录入结果

3. **Completed (已完成)**
   - 任务执行完毕
   - 设置ActualEndTime和CompleterNurseId
   - 对于ResultPending类任务，还需要设置ResultPayload

4. **Stopped (已停止)**
   - 医嘱停止导致的任务作废
   - 或任务被回滚/取消

---

## 三、代码修改详情

### 1. HasPendingTasksAsync方法

```csharp
/// <summary>
/// 检查是否已存在未完成的任务，避免重复生成
/// 注意：操作类医嘱没有取药任务（Verification类别），所以不需要检查Applying/Applied/AppliedConfirmed状态
/// 操作类医嘱的任务状态只有四种：Pending、InProgress、Completed、Stopped
/// </summary>
private async Task<bool> HasPendingTasksAsync(long orderId)
{
    try
    {
        // 操作类医嘱的任务状态只有四种：Pending、InProgress、Completed、Stopped
        // 不包含取药相关的状态（Applying、Applied、AppliedConfirmed）
        // 也不包含Running状态（操作类医嘱使用InProgress表示执行中）
        var existingTasks = await _taskRepository.ListAsync(t => 
            t.MedicalOrderId == orderId && 
            (t.Status == ExecutionTaskStatus.Pending || 
             t.Status == ExecutionTaskStatus.InProgress));

        var hasPending = existingTasks.Any();
        
        if (hasPending)
        {
            _logger.LogWarning("医嘱 {OrderId} 已存在 {TaskCount} 个未完成的执行任务", 
                orderId, existingTasks.Count());
        }

        return hasPending;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "检查医嘱 {OrderId} 的待执行任务时发生错误", orderId);
        return false;
    }
}
```

### 2. RollbackPendingTasksAsync方法

```csharp
// 查找所有未开始执行的任务
// 注意：操作类医嘱没有取药任务，所以不需要检查Applying/Applied/AppliedConfirmed状态
// 操作类医嘱的任务状态只有四种：Pending、InProgress、Completed、Stopped
// 只检查Pending、InProgress状态，且ActualStartTime为null（未开始执行）
var pendingTasks = await _taskRepository.ListAsync(t => 
    t.MedicalOrderId == orderId && 
    (t.Status == ExecutionTaskStatus.Pending || 
     t.Status == ExecutionTaskStatus.InProgress) &&
    t.ActualStartTime == null); // 只回滚未开始执行的任务
```

### 3. CheckAndUpdateOrderStatusAsync方法

```csharp
// 检查是否所有任务都已完成（Completed或Stopped）
// 操作类医嘱的任务状态只有四种：Pending、InProgress、Completed、Stopped
// 只要不是Completed或Stopped，就认为是未完成的任务
var incompleteTasks = allTasks.Where(t => 
    t.Status != ExecutionTaskStatus.Completed && 
    t.Status != ExecutionTaskStatus.Stopped).ToList();
```

### 4. 前端验证逻辑

```javascript
if (activeType.value === 'OperationOrder') {
  // 操作医嘱验证（参照药品类医嘱，必须选择病人）
  if (!selectedPatient.value) return false; // 添加病人选择验证
  if (!operationOrder.operationName) return false;
  // ... 其他验证
}
```

### 5. 前端暂存逻辑

```javascript
if (activeType.value === 'OperationOrder') {
  // 暂存操作医嘱（参照药品类医嘱，必须包含patientId）
  const orderData = {
    orderType: 'OperationOrder',
    patientId: selectedPatient.value.id, // 添加patientId字段
    // ... 其他字段
  };
}
```

---

## 四、测试建议

### 1. 状态流转测试
- 创建操作类医嘱并签收，验证任务状态为Pending
- 开始执行任务，验证状态变为InProgress
- 完成任务，验证状态变为Completed
- 停止医嘱，验证任务状态变为Stopped

### 2. 病人选择验证测试
- 未选择病人时，尝试暂存操作类医嘱，应该提示错误
- 选择病人后，暂存操作类医嘱，应该成功
- 验证暂存数据中包含patientId字段

### 3. 任务生成测试
- 验证不会重复生成任务（已有Pending或InProgress任务时）
- 验证回滚逻辑正确（只回滚未开始执行的任务）

---

## 五、与药品类医嘱的对比

| 项目 | 药品类医嘱 | 操作类医嘱 |
|------|-----------|-----------|
| 任务状态 | Pending、Applying、Applied、AppliedConfirmed、InProgress、Completed、Stopped等 | **只有四种：Pending、InProgress、Completed、Stopped** |
| 取药任务 | 有（Verification类别） | 无 |
| 病人选择验证 | ✅ 有 | ✅ 已添加 |
| 暂存patientId | ✅ 有 | ✅ 已添加 |

---

## 六、注意事项

1. **状态枚举**：`ExecutionTaskStatus`枚举中没有Running状态，只有InProgress状态
2. **状态流转**：操作类医嘱的任务状态流转更简单，不需要考虑取药相关的状态
3. **一致性**：所有操作类医嘱相关的代码都应该遵循四种状态的限制
4. **文档更新**：已更新相关文档，移除了Running状态的说明

