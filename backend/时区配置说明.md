# 时区配置说明

## 一、系统时区策略

### 1.1 时区使用原则
- **业务逻辑层**：统一使用**中国时间（UTC+8）**进行所有时间计算和比较
- **数据存储层**：PostgreSQL 数据库使用 **UTC 时间**存储（标准做法）
- **时区转换**：使用 `TimeZoneHelper` 工具类统一处理时区转换

### 1.2 时区转换规则
- **获取当前时间**：使用 `TimeZoneHelper.GetChinaTimeNow()` 替代 `DateTime.UtcNow`
- **存储到数据库**：使用 `TimeZoneHelper.ToUtcTime(chinaTime)` 将中国时间转换为UTC
- **从数据库读取**：使用 `TimeZoneHelper.ToChinaTime(utcTime)` 将UTC转换为中国时间
- **时间比较**：统一转换为中国时间后再进行比较

## 二、PostgreSQL 时区配置

### 2.1 数据库时区设置

PostgreSQL 默认使用 UTC 时间存储 `timestamp with time zone` 类型的数据，这是正确的做法。

**检查数据库时区：**
```sql
SHOW timezone;
```

**设置数据库时区（如果需要）：**
```sql
-- 设置为 UTC（推荐，因为我们已经统一在应用层处理时区转换）
SET timezone = 'UTC';

-- 或者设置为中国时区（不推荐，因为会导致时区混乱）
SET timezone = 'Asia/Shanghai';
```

### 2.2 连接字符串配置

在 `appsettings.json` 中的连接字符串可以添加时区参数：

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=hospital;Username=hos_user;Password=hos_password123;Timezone=UTC;"
  }
}
```

**注意**：即使设置了 `Timezone=UTC`，PostgreSQL 仍然会正确存储 UTC 时间。应用层应该统一使用 `TimeZoneHelper` 进行时区转换。

### 2.3 Docker 容器时区配置

如果使用 Docker 运行 PostgreSQL，可以在 `docker-compose.yml` 中设置时区：

```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: hospital
      POSTGRES_USER: hos_user
      POSTGRES_PASSWORD: hos_password123
      TZ: UTC  # 设置容器时区为 UTC
    volumes:
      - postgres_data:/var/lib/postgresql/data
```

## 三、代码中的时区处理

### 3.1 TimeZoneHelper 工具类

所有时区转换都通过 `TimeZoneHelper` 工具类处理：

```csharp
using CareFlow.Core.Utils;

// 获取当前中国时间
var now = TimeZoneHelper.GetChinaTimeNow();

// 将中国时间转换为UTC（用于存储到数据库）
var utcTime = TimeZoneHelper.ToUtcTime(chinaTime);

// 将UTC时间转换为中国时间（用于显示和比较）
var chinaTime = TimeZoneHelper.ToChinaTime(utcTime);

// 获取今天的日期（中国时间）
var today = TimeZoneHelper.GetChinaTimeToday();
```

### 3.2 操作类医嘱中的时区处理

#### 3.2.1 医嘱创建
```csharp
// 创建时间使用中国时间，转换为UTC存储
order.CreateTime = TimeZoneHelper.ToUtcTime(TimeZoneHelper.GetChinaTimeNow());
```

#### 3.2.2 任务生成
```csharp
// 任务时间计算使用中国时间
var chinaTimeNow = TimeZoneHelper.GetChinaTimeNow();
var plannedTimeChina = chinaTimeNow.Date.Add(timeSpan);

// 存储时转换为UTC
var plannedTimeUtc = TimeZoneHelper.ToUtcTime(plannedTimeChina);
task.PlannedStartTime = plannedTimeUtc;
```

#### 3.2.3 时间比较
```csharp
// 比较时统一转换为中国时间
var currentTimeChina = TimeZoneHelper.GetChinaTimeNow();
var taskTimeChina = TimeZoneHelper.ToChinaTime(task.PlannedStartTime);

if (taskTimeChina < currentTimeChina)
{
    // 任务已过期
}
```

## 四、常见问题

### 4.1 为什么数据库使用 UTC 时间？

- **标准化**：UTC 是国际标准时间，不受夏令时影响
- **一致性**：不同时区的用户访问时，数据一致
- **最佳实践**：大多数系统都采用 UTC 存储，应用层转换的策略

### 4.2 为什么应用层使用中国时间？

- **业务需求**：系统主要在中国使用，业务逻辑基于中国时间
- **用户体验**：用户看到的时间应该是中国时间
- **时间计算**：任务生成、时间比较等逻辑都基于中国时间

### 4.3 如何验证时区配置是否正确？

1. **检查数据库时区**：
   ```sql
   SHOW timezone;
   SELECT NOW();  -- 查看数据库当前时间
   ```

2. **检查应用层时区**：
   ```csharp
   var chinaTime = TimeZoneHelper.GetChinaTimeNow();
   var utcTime = TimeZoneHelper.ToUtcTime(chinaTime);
   Console.WriteLine($"中国时间: {chinaTime}");
   Console.WriteLine($"UTC时间: {utcTime}");
   Console.WriteLine($"时差: {chinaTime - utcTime}");  // 应该是 8 小时
   ```

3. **测试任务生成**：
   - 创建一个操作医嘱，设置执行时间为当前时间之后
   - 检查生成的任务时间是否正确（应该是中国时间）
   - 检查数据库中存储的时间（应该是UTC时间，比中国时间早8小时）

## 五、时区处理检查清单

- [x] 创建 `TimeZoneHelper` 工具类
- [x] 修复 `OperationOrderManager` 中的时间处理
- [x] 修复 `OperationExecutionTaskFactory` 中的时间处理
- [x] 修复 `OperationOrderTaskService` 中的时间处理
- [ ] 检查其他服务中的时间处理（如 `MedicationOrderTaskService`、`InspectionOrderTaskService` 等）
- [ ] 检查 Controller 层的时间处理
- [ ] 验证 PostgreSQL 时区配置
- [ ] 编写时区处理单元测试

## 六、后续优化建议

1. **统一时间处理**：考虑创建一个中间件或过滤器，自动处理所有时间字段的时区转换
2. **时间序列化**：在 API 响应中，自动将 UTC 时间转换为中国时间返回给前端
3. **日志记录**：在日志中记录时区信息，便于调试
4. **单元测试**：编写时区转换的单元测试，确保转换正确

