# 操作类医嘱（OperationOrder）完整实现说明

## 一、已创建的文件

### 1. 核心服务层
- `CareFlow.Application/Services/MedicalOrder/OperationExecutionTaskFactory.cs`
  - 任务生成工厂，根据频次类型生成执行任务
- `CareFlow.Application/Services/MedicalOrder/OperationOrderTaskService.cs`
  - 任务服务层，处理任务生成、刷新、回滚
- `CareFlow.Application/Services/MedicalOrder/OperationOrderManager.cs`
  - 操作医嘱管理服务（独立入口，不修改 MedicalOrderManager）

### 2. Controller 层
- `CareFlow.WebApi/Controller/OperationOrderController.cs`
  - 操作医嘱创建 API（独立入口）
- `CareFlow.WebApi/Controller/OperationOrderTaskController.cs`
  - 任务管理 API（生成、刷新、回滚、查询、条形码）

### 3. DTO 层
- `CareFlow.Application/DTOs/OperationOrder/GenerateOperationTasksRequestDto.cs`
  - 生成任务请求 DTO
- `CareFlow.Application/DTOs/OperationOrder/CreateOperationOrderRequestDto.cs`
  - 创建操作医嘱请求 DTO

### 4. 配置
- `Program.cs` - 已注册所有服务

## 二、条形码功能集成

### 条形码使用流程

1. **任务生成时自动创建条形码索引**
   - 位置：`OperationOrderTaskService.GenerateBarcodeForTask()`
   - 每个执行任务自动生成 `BarcodeIndex` 记录
   - 条形码格式：`EXECUTIONTASKS-{TaskId}`

2. **护士执行任务时扫码验证**
   - 使用现有的 `BarcodeMatchingController.ValidateBarcodeMatch()` API
   - 支持的任务类型：`Immediate`、`Duration`（操作类医嘱使用的类型）
   - 验证内容：
     - 执行任务条形码 + 患者条形码匹配
     - 患者ID是否匹配
     - 执行时间是否在允许范围内（默认±30分钟）

3. **获取任务条形码图片**
   - API：`GET /api/OperationOrderTask/task/{taskId}/barcode`
   - 返回：PNG 格式的条形码图片

### 条形码验证流程

```
护士扫码
    ↓
扫描执行任务条形码 + 患者腕带条形码
    ↓
POST /api/BarcodeMatching/validate
    ↓
BarcodeMatchingService.ValidateBarcodeMatchAsync()
    ↓
验证：
1. 解码两个条形码
2. 获取执行任务详情
3. 验证任务类型（Immediate/Duration 支持）
4. 验证患者ID匹配
5. 验证时间窗口（±30分钟）
6. 验证任务状态（Pending/Running）
    ↓
返回匹配结果
```

## 三、API 端点列表

### 操作医嘱创建
- `POST /api/OperationOrder/create`
  - 创建操作医嘱，自动分配护士
  - 请求体：`CreateOperationOrderRequestDto`

### 任务管理
- `POST /api/OperationOrderTask/{orderId}/generate`
  - 为操作医嘱生成执行任务
  - 路由参数：`orderId`（操作医嘱ID）

- `POST /api/OperationOrderTask/{orderId}/refresh`
  - 刷新任务（医嘱变更后）

- `POST /api/OperationOrderTask/{orderId}/rollback`
  - 回滚未完成任务

- `GET /api/OperationOrderTask/{orderId}/tasks`
  - 查询医嘱的所有任务

- `GET /api/OperationOrderTask/task/{taskId}/barcode`
  - 获取任务条形码图片

### 条形码验证（复用现有）
- `POST /api/BarcodeMatching/validate`
  - 验证执行任务条形码和患者条形码匹配

## 四、任务生成策略

### 1. "每天" + "N次"
- 生成多个任务，每天 N 次
- 时间分布：
  - 1次：08:00
  - 2次：08:00, 20:00
  - 3次：08:00, 14:00, 20:00
  - 4次：08:00, 12:00, 16:00, 20:00
  - 更多：均匀分布
- 任务类别：`Immediate`（即刻执行）

### 2. "持续" + "N小时"
- 生成 1 个持续任务
- 开始时间：医嘱创建时间
- 结束时间：开始时间 + N 小时（不超过医嘱结束时间）
- 任务类别：`Duration`（持续任务）

### 3. "一次性" + "1次"
- 生成 1 个任务
- 执行时间：医嘱创建时间
- 任务类别：`Immediate`（即刻执行）

## 五、数据流

```
医生创建操作医嘱
    ↓
POST /api/OperationOrder/create
    ↓
OperationOrderController.CreateOperationOrder()
    ↓
OperationOrderManager.CreateOperationOrderAsync()
    ├── 自动分配护士（根据患者床位和排班）
    └── 保存到 OperationOrders 表
    ↓
返回 OrderId
    ↓
医生/系统触发任务生成
    ↓
POST /api/OperationOrderTask/{orderId}/generate
    ↓
OperationOrderTaskController.GenerateTasks(orderId)
    ↓
OperationOrderTaskService.GenerateExecutionTasksAsync()
    ├── 验证医嘱
    ├── 调用 Factory 生成任务
    ├── 批量保存到 ExecutionTasks 表
    └── 为每个任务生成条形码索引（BarcodeIndexes 表）
    ↓
返回任务列表
    ↓
护士查看任务列表
    ↓
GET /api/Nursing/my-tasks
    ↓
护士执行任务
    ├── 扫码验证（可选）
    │   └── POST /api/BarcodeMatching/validate
    ├── 开始执行 → 更新状态为 Running
    └── 完成任务 → 更新状态为 Completed
```

## 六、条形码使用示例

### 1. 获取任务条形码
```http
GET /api/OperationOrderTask/task/5001/barcode
Response: PNG 图片
```

### 2. 验证患者身份
```http
POST /api/BarcodeMatching/validate
Content-Type: multipart/form-data

executionTaskBarcode: [任务条形码图片文件]
patientBarcode: [患者腕带条形码图片文件]
toleranceMinutes: 30
checkTime: true

Response:
{
  "isMatched": true,
  "executionTaskId": 5001,
  "patientId": "P001",
  "plannedStartTime": "2025-01-08T08:00:00Z",
  "scanTime": "2025-01-08T08:05:00Z",
  "timeDifferenceMinutes": 5.0,
  "validationDetails": {
    "patientIdMatched": true,
    "executionTimeMatched": true,
    "executionTaskStatusValid": true
  }
}
```

## 七、关键设计要点

1. **独立入口**：不修改 `MedicalOrderController` 和 `MedicalOrderManager`
2. **条形码集成**：自动生成条形码索引，支持扫码验证患者身份
3. **任务类别**：使用 `Immediate` 和 `Duration`，已支持条形码验证
4. **时间计算**：基于频次类型智能分配执行时间
5. **错误处理**：完善的验证和异常处理

## 八、测试建议

1. 创建操作医嘱（不同频次类型）
2. 生成执行任务
3. 验证任务数量和时间分布
4. 测试条形码生成和验证
5. 测试任务刷新和回滚

