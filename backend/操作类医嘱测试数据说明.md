# 操作类医嘱测试数据说明

## 一、测试数据概览

在 `Dbinitializer.cs` 中已添加 **28 条操作类医嘱测试数据**，覆盖所有操作类型、任务类别和频次场景。

## 二、测试数据分类

### 2.1 Immediate 类操作（即刻执行，扫码即完成）

共 **7 条测试数据**：

| OpId | 操作名称 | 患者 | 频次类型 | 频次值 | 说明 |
|------|---------|------|---------|--------|------|
| OP001 | 更换引流袋 | P001 | 1天2次 | 08:00,20:00 | 长期医嘱，每天早晚各一次 |
| OP004 | 更换敷料 | P002 | 1天1次 | 10:00 | 长期医嘱，每天一次 |
| OP005 | 导尿 | P003 | 一次性 | 立即 | 临时医嘱，立即执行 |
| OP008 | 口腔护理 | P001 | 1天3次 | 08:00,14:00,20:00 | 长期医嘱，每天三次 |
| OP009 | 会阴护理 | P002 | 1天2次 | 09:00,21:00 | 长期医嘱，每天两次 |
| OP010 | 皮肤护理 | P003 | 1天1次 | 15:00 | 长期医嘱，每天一次 |
| OP015 | 翻身拍背 | P004 | 1天4次 | 08:00,12:00,16:00,20:00 | 长期医嘱，每天四次 |

### 2.2 Duration 类操作（持续执行，需要开始和结束时间）

共 **7 条测试数据**：

| OpId | 操作名称 | 患者 | 频次类型 | 频次值 | 说明 |
|------|---------|------|---------|--------|------|
| OP002 | 持续吸氧 | P003 | 1天1次 | 08:00 | 长期医嘱，每天一次 |
| OP006 | 鼻饲 | P001 | 1天3次 | 07:00,12:00,18:00 | 长期医嘱，每天三次 |
| OP007 | 雾化吸入 | P002 | 1天2次 | 09:00,15:00 | 长期医嘱，每天两次 |
| OP011 | 持续心电监护 | P003 | 1天1次 | 00:00 | 长期医嘱，全天持续 |
| OP012 | 持续导尿 | P004 | 1天1次 | 08:00 | 长期医嘱，每天一次 |
| OP013 | 持续胃肠减压 | P005 | 1天1次 | 10:00 | 长期医嘱，每天一次 |
| OP014 | 持续静脉输液 | P006 | 1天2次 | 08:00,14:00 | 长期医嘱，每天两次 |

### 2.3 ResultPending 类操作（需要等待结果，录入结果后完成）

共 **6 条测试数据**：

| OpId | 操作名称 | 患者 | 频次类型 | 频次值 | 说明 |
|------|---------|------|---------|--------|------|
| OP003 | 血糖监测 | P002 | 1天3次 | 07:00,12:00,18:00 | 长期医嘱，每天三次 |
| OP016 | 血压监测 | P001 | 1天2次 | 08:00,20:00 | 长期医嘱，每天两次 |
| OP017 | 体温监测 | P003 | 1天4次 | 06:00,12:00,18:00,22:00 | 长期医嘱，每天四次 |
| OP018 | 尿量监测 | P004 | 1天1次 | 08:00 | 长期医嘱，每天一次 |
| OP019 | 意识状态评估 | P005 | 1天2次 | 08:00,20:00 | 长期医嘱，每天两次 |
| OP020 | 疼痛评估 | P006 | 1天3次 | 08:00,14:00,20:00 | 长期医嘱，每天三次 |

### 2.4 特殊场景测试

共 **8 条测试数据**，用于测试特殊场景：

| 场景 | OpId | 患者 | 频次类型 | 频次值 | 说明 |
|------|------|------|---------|--------|------|
| 2天1次 | OP001 | P001 | 2天1次 | 10:00 | 每2天执行一次 |
| 临时-指定时间 | OP003 | P002 | 一次性 | 14:30 | 临时医嘱，指定未来时间 |
| 临时-立即执行 | OP005 | P003 | 一次性 | 立即 | 临时医嘱，立即执行 |
| 时间已过-1天1次 | OP002 | P004 | 1天1次 | 08:00 | 创建时间2天前，用于测试时间过滤 |
| 时间已过-1天3次 | OP003 | P005 | 1天3次 | 06:00,12:00,18:00 | 创建时间1天前，部分时间已过 |

## 三、测试场景覆盖

### 3.1 操作类型覆盖
- ✅ **Immediate 类**：7 种操作（OP001, OP004, OP005, OP008, OP009, OP010, OP015）
- ✅ **Duration 类**：7 种操作（OP002, OP006, OP007, OP011, OP012, OP013, OP014）
- ✅ **ResultPending 类**：6 种操作（OP003, OP016, OP017, OP018, OP019, OP020）

### 3.2 频次类型覆盖
- ✅ **长期医嘱**：
  - 1天1次
  - 1天2次
  - 1天3次
  - 1天4次
  - 2天1次（每2天执行一次）
- ✅ **临时医嘱**：
  - 一次性 + 立即执行
  - 一次性 + 指定时间（未来时间）

### 3.3 时间场景覆盖
- ✅ **正常场景**：创建时间在现在，结束时间在未来
- ✅ **时间已过场景**：创建时间在过去，用于测试时间过滤逻辑
- ✅ **部分时间已过场景**：长期医嘱，部分时间点已过，用于测试时间过滤

### 3.4 患者覆盖
- ✅ **P001**：4 条医嘱（Immediate × 2, Duration × 1, ResultPending × 1）
- ✅ **P002**：4 条医嘱（Immediate × 2, Duration × 1, ResultPending × 1）
- ✅ **P003**：4 条医嘱（Immediate × 2, Duration × 2）
- ✅ **P004**：3 条医嘱（Immediate × 1, Duration × 1, ResultPending × 1）
- ✅ **P005**：2 条医嘱（Duration × 1, ResultPending × 1）
- ✅ **P006**：2 条医嘱（Duration × 1, ResultPending × 1）

## 四、时区处理

所有测试数据都使用 `TimeZoneHelper` 进行时区转换：

```csharp
// 获取当前中国时间
var chinaTimeNow = TimeZoneHelper.GetChinaTimeNow();
var chinaTimeToday = chinaTimeNow.Date;

// 转换为UTC存储到数据库
CreateTime = TimeZoneHelper.ToUtcTime(chinaTimeToday.AddDays(-1)),
PlantEndTime = TimeZoneHelper.ToUtcTime(chinaTimeToday.AddDays(3)),
```

**时区转换规则**：
- 业务逻辑使用**中国时间（UTC+8）**
- 数据库存储使用**UTC时间**
- 所有时间计算和比较都基于中国时间

## 五、测试建议

### 5.1 任务生成测试

1. **测试所有操作类型**：
   ```bash
   # 为每条医嘱生成任务（通过路由参数传递医嘱ID）
   POST /api/OperationOrderTask/{orderId}/generate
   
   # 示例：
   POST /api/OperationOrderTask/123/generate
   ```

2. **验证任务类别**：
   - Immediate 类：任务类别应为 `Immediate`
   - Duration 类：任务类别应为 `Duration`
   - ResultPending 类：任务类别应为 `ResultPending`

3. **验证任务数量**：
   - 1天1次：应生成 N 个任务（N = 医嘱持续天数）
   - 1天3次：应生成 3N 个任务
   - 1天4次：应生成 4N 个任务
   - 2天1次：应生成 N/2 个任务（向上取整）

### 5.2 时间过滤测试

1. **测试时间已过的医嘱**：
   - 创建时间2天前，1天1次，08:00
   - 应过滤掉所有已过时间点
   - 只保留未来时间点的任务

2. **测试部分时间已过的医嘱**：
   - 创建时间1天前，1天3次，06:00,12:00,18:00
   - 应过滤掉今天已过的时间点（06:00,12:00）
   - 保留今天未过的时间点（18:00）和未来所有时间点

3. **测试临时医嘱时间验证**：
   - 临时医嘱，指定时间已过：应报错，不生成任务
   - 临时医嘱，指定时间未过：应正常生成任务

### 5.3 时区测试

1. **验证时间转换**：
   - 检查数据库中存储的时间（应为UTC）
   - 检查任务生成时的时间计算（应基于中国时间）
   - 验证时差为8小时

2. **验证时间比较**：
   - 任务时间过滤应基于中国时间
   - 时间比较结果应正确

## 六、数据统计

- **总医嘱数**：28 条
- **Immediate 类**：7 条
- **Duration 类**：7 条
- **ResultPending 类**：6 条
- **特殊场景**：8 条
- **长期医嘱**：25 条
- **临时医嘱**：3 条

## 七、使用示例

### 7.1 生成任务

```bash
# 为 P001 的更换引流袋医嘱生成任务（通过路由参数传递医嘱ID）
POST /api/OperationOrderTask/{orderId}/generate

# 示例：
POST /api/OperationOrderTask/123/generate

# 预期结果：
# - 任务类别：Immediate
# - 任务数量：根据医嘱持续天数 × 2（每天2次）
# - 任务时间：每天 08:00 和 20:00（中国时间）
```

### 7.2 查询任务

```bash
# 查询某条医嘱的所有任务
GET /api/OperationOrderTask/{orderId}/tasks

# 预期结果：
# - 返回该医嘱的所有执行任务
# - 任务按 PlannedStartTime 排序
# - 已过时间的任务应被过滤（长期医嘱）或报错（临时医嘱）
```

## 八、注意事项

1. **时区处理**：所有时间都使用 `TimeZoneHelper` 处理，确保时区正确
2. **时间过滤**：长期医嘱会自动过滤已过时间点，临时医嘱会报错
3. **任务类别**：任务类别仅由 OpId 决定，与频次类型无关
4. **数据初始化**：每次数据库初始化都会重新创建这些测试数据

## 九、后续扩展

如需添加更多测试数据，可以：
1. 在 `operationOrders` 列表中添加新的 `OperationOrder` 对象
2. 确保使用 `TimeZoneHelper` 处理时区
3. 覆盖更多特殊场景（如跨天、跨周等）

